{% extends "base.html" %}

{% block title %}ä¸Šä¼ æ•´åˆåŒ…{% endblock %}

{% block content %}
<div class="login-form">
    <h2>ğŸ“¦ ä¸Šä¼ æ•´åˆåŒ…</h2>

    <div class="form-group">
        <label>æ•´åˆåŒ…åç§°:</label>
        <input type="text" id="name" required>
    </div>

    <div class="form-group">
        <label>ç‰ˆæœ¬:</label>
        <input type="text" id="version" required>
    </div>

    <div class="form-group">
        <label>é€‰æ‹©æ–‡ä»¶:</label>
        <input type="file" id="fileInput" accept=".zip,.rar,.7z" required>
        <small style="color: #666;">æ”¯æŒ ZIP, RAR, 7Z æ ¼å¼</small>
    </div>

    <div class="form-group">
        <label>æ•´åˆåŒ…ä»‹ç»:</label>
        <textarea id="description" rows="4" style="width:100%; padding:10px; border:2px solid #ddd; border-radius:5px;"></textarea>
    </div>

    <button type="button" id="uploadBtn" class="submit-btn">å¼€å§‹ä¸Šä¼ </button>

    <div id="progressBar" style="display:none; width:100%; height:8px; background:#eee; border-radius:4px; margin-top:12px;">
        <div id="progressInner" style="height:100%; width:0; background:#667eea;"></div>
    </div>

    <a href="{{ url_for('admin_dashboard') }}" style="display:inline-block; margin-top:10px; color:#667eea; text-decoration:none;">è¿”å›ç®¡ç†åå°</a>
</div>

<script>
/* å…¼å®¹é HTTPS çš„ uuid */
function uuidv4() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = Math.random() * 16 | 0;
    return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
  });
}

const CHUNK = 10 * 1024 * 1024;
const btn       = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
const inner     = document.getElementById('progressInner');
const bar       = document.getElementById('progressBar');

btn.onclick = async () => {
  const file = fileInput.files[0];
  if (!file) return alert('è¯·é€‰æ‹©æ–‡ä»¶');

  const uuid  = uuidv4();
  const total = Math.ceil(file.size / CHUNK);

  btn.disabled = true;
  bar.style.display = 'block';

  /* 1. ä¸Šä¼ æ‰€æœ‰åˆ†ç‰‡ */
  for (let i = 0; i < total; i++) {
    const fd = new FormData();
    fd.append('file', file.slice(i * CHUNK, (i + 1) * CHUNK));
    fd.append('chunk', i);
    fd.append('chunks', total);
    fd.append('uuid', uuid);
    fd.append('filename', file.name);

    await fetch("{{ url_for('upload_pack') }}", {method: 'POST', body: fd});
    inner.style.width = ((i + 1) / total * 100).toFixed(0) + '%';
  }

  /* 2. åˆå¹¶ */
  const merge = new FormData();
  merge.append('uuid', uuid);
  merge.append('filename', file.name);
  merge.append('name', document.getElementById('name').value);
  merge.append('version', document.getElementById('version').value);
  merge.append('description', document.getElementById('description').value);
  merge.append('total_chunks', total);

  const resp = await fetch("{{ url_for('upload_pack') }}", {method: 'POST', body: merge});
  if (!resp.ok) {
    const text = await resp.text();
    alert('åˆå¹¶å¤±è´¥ï¼š' + text.slice(0, 300));
    btn.disabled = false;
    return;
  }

  const data = await resp.json();
  if (data.status === 'done') {
    window.location.href = data.redirect;
  }
};
</script>
{% endblock %}